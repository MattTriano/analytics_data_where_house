{{ config(materialized='table') }}

WITH last_parcel_sale AS (
    SELECT
        parcel_sale_id,
        pin,
        is_multisale,
        num_parcels_sale,
        sale_date,
        sale_price,
        LAG(sale_date, 1) OVER (PARTITION BY pin ORDER BY pin ASC, sale_date ASC) AS last_sale_date,
        LAG(sale_price, 1) OVER (PARTITION BY pin ORDER BY pin ASC, sale_date ASC) AS last_sale_price,
        LAG(is_multisale, 1) OVER (PARTITION BY pin ORDER BY pin ASC, sale_date ASC) AS last_sale_was_multisale,
        LAG(num_parcels_sale, 1) OVER (PARTITION BY pin ORDER BY pin ASC, sale_date ASC) AS num_parcels_last_sale,
        class,
        CASE
            WHEN class = 'EX' THEN 'EXEMPT PROPERTY'
            WHEN class = 'RR' THEN 'RAILROAD PROPERTY'
            WHEN class = '100' THEN 'VACANT LAND'
            WHEN class = '190' THEN 'MINOR IMPROVEMENT ON VACANT LAND'
            WHEN class = '200' THEN 'RESIDENTIAL LAND'
            WHEN class = '201' THEN 'RESIDENTIAL GARAGE'
            WHEN class = '202' THEN 'ONE-STORY RESIDENCE, ANY AGE, UP TO 999 SQUARE FEET'
            WHEN class = '203' THEN 'ONE-STORY RESIDENCE, ANY AGE, 1,000 TO 1,800 SQUARE FEET'
            WHEN class = '204' THEN 'ONE-STORY RESIDENCE, ANY AGE, 1,801 SQUARE FEET AND OVER'
            WHEN class = '205' THEN 'TWO-OR-MORE STORY RESIDENCE, OVER 62 YEARS OF AGE UP TO 2,200 SQUARE FEET'
            WHEN class = '206' THEN 'TWO-OR-MORE STORY RESIDENCE, OVER 62 YEARS OF AGE, 2,201 TO 4,999 SQUARE FEET'
            WHEN class = '207' THEN 'TWO-OR-MORE STORY RESIDENCE, UP TO 62 YEARS OF AGE, UP TO 2,000 SQUARE FEET'
            WHEN class = '208' THEN 'TWO-OR-MORE STORY RESIDENCE, UP TO 62 YEARS OF AGE, 3,801 TO 4,999 SQUARE FEET'
            WHEN class = '209' THEN 'TWO-OR-MORE STORY RESIDENCE, ANY AGE, 5,000 SQUARE FEET AND OVER'
            WHEN class = '210' THEN 'OLD STYLE ROW HOUSE (TOWN HOME), OVER 62 YEARS OF AGE'
            WHEN class = '211' THEN 'APARTMENT BUILDING WITH 2 TO 6 UNITS, ANY AGE'
            WHEN class = '212' THEN 'MIXED-USE COMMERCIAL/RESIDENTIAL BUILDING WITH APARTMENT AND COMMERCIAL AREA TOTALING 6 UNITS OR LESS WITH A SQUARE FOOT AREA LESS THAN 20,000 SQUARE FEET, ANY AGE'
            WHEN class = '213' THEN 'COOPERATIVE'
            WHEN class = '218' THEN 'A RESIDENTIAL BUILDING LICENSED AS A BED & BREAKFAST BY THE MUNICIPALITY, COUNTY OF COOK OR REGISTERED AS A BED & BREAKFAST WITH THE STATE OF ILLINOIS UNDER 50 ILCS 820/1 ET.SEQ., WITH SIX OR FEWER RENTABLE UNITS AND WHERE ONE UNIT IS OWNER OCCUPIED AND IS ENTITLED TO A HOMEOWNERS EXEMPTION PURSUANT TO THE PROPERTY TAX CODE.'
            WHEN class = '219' THEN 'A RESIDENTIAL BUILDING LICENSED AS A BED & BREAKFAST BY THE MUNICIPALITY, COUNTY OF COOK OR REGISTERED AS A BED & BREAKFAST WITH THE STATE OF ILLINOIS UNDER 50 ILCS 820/1 ET.SEQ., WITH SIX OR FEWER RENTABLE UNITS AND WHERE NONE OF THE UNITS IS OWNER OCCUPIED AND NO HOMEOWNERS EXEMPTION IS ALLOWED PURSUANT TO THE PROPERTY TAX CODE.'
            WHEN class = '224' THEN 'FARM BUILDING'
            WHEN class = '225' THEN 'SINGLE-ROOM OCCUPANCY RENTAL BUILDING'
            WHEN class = '234' THEN 'SPLIT LEVEL RESIDENCE WITH A LOWER LEVEL BELOW GRADE (GROUND LEVEL) ALL AGES, ALL SIZES'
            WHEN class = '236' THEN 'ANY RESIDENCE LOCATED ON A PARCEL USED PRIMARILY FOR COMMERCIAL OR INDUSTRIAL PURPOSES'
            WHEN class = '239' THEN 'NON-EQUALIZED LAND UNDER AGRICULTURAL USE, VALUED AT FARM PRICING'
            WHEN class = '240' THEN 'FIRST-TIME AGRICULTURAL USE OF LAND VALUED AT MARKET PRICE'
            WHEN class = '241' THEN 'VACANT LAND UNDER COMMON OWNERSHIP WITH ADJACENT RESIDENCE'
            WHEN class = '278' THEN 'TWO-OR-MORE STORY RESIDENCE, UP TO 62 YEARS OF AGE, 2,001 TO 3,800 SQUARE FEET'
            WHEN class = '288' THEN 'HOME IMPROVEMENT EXEMPTION'
            WHEN class = '290' THEN 'MINOR IMPROVEMENT'
            WHEN class = '295' THEN 'INDIVIDUALLY-OWNED TOWNHOME OR ROW HOUSE UP TO 62 YEARS OF AGE'
            WHEN class = '297' THEN 'SPECIAL RESIDENTIAL IMPROVEMENTS (MAY APPLY TO CONDO BUILDING IN FIRST YEAR OF CONSTRUCTION BEFORE DIVISION INTO INDIVIDUAL UNITS.)'
            WHEN class = '299' THEN 'RESIDENTIAL CONDOMINIUM'
            WHEN class = '300' THEN 'LAND USED IN CONJUNCTION WITH RENTAL APARTMENTS'
            WHEN class = '301' THEN 'GARAGE USED IN CONJUNCTION WITH RENTAL APARTMENTS'
            WHEN class = '313' THEN 'TWO-OR-THREE-STORY, BUILDING, SEVEN OR MORE UNITS'
            WHEN class = '314' THEN 'TWO-OR-THREE-STORY, NON-FIREPROOF BUILDING WITH CORRIDOR APARTMENT OR CALIFORNIA TYPE APARTMENTS, NO CORRIDORS EXTERIOR ENTRANCE'
            WHEN class = '315' THEN 'TWO-OR-THREE-STORY, NON-FIREPROOF CORRIDOR APARTMENTS OR CALIFORNIA TYPE APARTMENTS, INTERIOR ENTRANCE'
            WHEN class = '318' THEN 'MIXED-USE COMMERCIAL/RESIDENTIAL BUILDING WITH APARTMENTS AND COMMERCIAL AREA TOTALING SEVEN UNITS OR MORE WITH A SQUARE-FOOT AREA OF OVER 20,000 SQUARE FEET'
            WHEN class = '390' THEN 'OTHER MINOR IMPROVEMENT RELATED TO RENTAL USE'
            WHEN class = '391' THEN 'APARTMENT BUILDING OVER THREE STORIES, SEVEN OR MORE UNITS'
            WHEN class = '396' THEN 'RENTED MODERN ROW HOUSES, SEVEN OR MORE UNITS IN A SINGLE DEVELOPMENT OR ONE OR MORE CONTIGUOUS PARCELS IN COMMON OWNERSHIP'
            WHEN class = '397' THEN 'SPECIAL RENTAL STRUCTURE'
            WHEN class = '399' THEN 'RENTAL CONDOMINIUM'
            WHEN class = '400' THEN 'NOT-FOR-PROFIT LAND'
            WHEN class = '401' THEN 'NOT-FOR-PROFIT GARAGE'
            WHEN class = '417' THEN 'NOT-FOR-PROFIT ONE STORY COMMERCIAL BUILDING'
            WHEN class = '418' THEN 'NOT-FOR-PROFIT TWO-OR-THREE STORY MIXED USE COMMERCIAL/RESIDENTIAL BUILDING'
            WHEN class = '422' THEN 'NOT-FOR-PROFIT ONE-STORY NON-FIREPROOF PUBLIC GARAGE'
            WHEN class = '423' THEN 'NOT-FOR-PROFIT GASOLINE STATION'
            WHEN class = '426' THEN 'NOT-FOR-PROFIT COMMERCIAL GREENHOUSE'
            WHEN class = '427' THEN 'NOT-FOR-PROFIT THEATRE'
            WHEN class = '428' THEN 'NOT-FOR-PROFIT BANK BUILDING'
            WHEN class = '429' THEN 'NOT-FOR-PROFIT MOTEL'
            WHEN class = '430' THEN 'NOT-FOR-PROFIT SUPERMARKET'
            WHEN class = '431' THEN 'NOT-FOR-PROFIT SHOPPING CENTER'
            WHEN class = '432' THEN 'NOT-FOR-PROFIT BOWLING ALLEY'
            WHEN class = '433' THEN 'NOT-FOR-PROFIT QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '435' THEN 'NOT-FOR-PROFIT GOLF COURSE IMPROVEMENT'
            WHEN class = '480' THEN 'NOT-FOR-PROFIT INDUSTRIAL MINOR IMPROVEMENT'
            WHEN class = '481' THEN 'NOT-FOR-PROFIT GARAGE USED IN CONJUNCTION WITH INDUSTRIAL IMPROVEMENT'
            WHEN class = '483' THEN 'NOT-FOR-PROFIT INDUSTRIAL QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '487' THEN 'NOT-FOR-PROFIT SPECIAL INDUSTRIAL IMPROVEMENT'
            WHEN class = '489' THEN 'NOT-FOR-PROFIT INDUSTRIAL CONDOMINIUM'
            WHEN class = '490' THEN 'NOT-FOR-PROFIT COMMERCIAL MINOR IMPROVEMENT'
            WHEN class = '491' THEN 'NOT-FOR-PROFIT IMPROVEMENT OVER THREE STORIES'
            WHEN class = '492' THEN 'NOT-FOR-PROFIT, TWO-OR-THREE STORY BUILDING CONTAINING PART OR ALL RETAIL AND/OR COMMERCIAL SPACE'
            WHEN class = '493' THEN 'NOT-FOR-PROFITINDUSTRIAL BUILDING'
            WHEN class = '496' THEN 'NOT-FOR-PROFIT, RENTED MODERN ROW HOUSES, SEVEN OR MORE UNITS IN A SINGLE DEVELOPMENT'
            WHEN class = '497' THEN 'NOT-FOR-PROFIT SPECIAL STRUCTURE'
            WHEN class = '499' THEN 'NOT-FOR-PROFIT CONDOMINIUM'
            WHEN class = '500' THEN 'COMMERCIAL LAND'
            WHEN class = '501' THEN 'GARAGE USED IN CONJUNCTION WITH COMMERCIAL IMPROVEMENTS'
            WHEN class = '516' THEN 'NON-FIREPROOF HOTEL OR ROOMING HOUSE (APARTMENT HOTEL)'
            WHEN class = '517' THEN 'ONE-STORY COMMERCIAL BUILDING'
            WHEN class = '522' THEN 'ONE-STORY, NON-FIREPROOF PUBLIC GARAGE'
            WHEN class = '523' THEN 'GASOLINE STATION'
            WHEN class = '526' THEN 'COMMERCIAL GREENHOUSE'
            WHEN class = '527' THEN 'THEATRE'
            WHEN class = '528' THEN 'BANK BUILDING'
            WHEN class = '529' THEN 'MOTEL'
            WHEN class = '530' THEN 'SUPERMARKET'
            WHEN class = '531' THEN 'SHOPPING CENTER'
            WHEN class = '532' THEN 'BOWLING ALLEY'
            WHEN class = '533' THEN 'QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '535' THEN 'GOLF COURSE LAND'
            WHEN class = '550' THEN 'INDUSTRIAL LAND'
            WHEN class = '580' THEN 'INDUSTRIAL MINOR IMPROVEMENT'
            WHEN class = '581' THEN 'GARAGE USED IN CONJUNCTION WITH INDUSTRIAL IMPROVEMENT'
            WHEN class = '583' THEN 'INDUSTRIAL QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '587' THEN 'SPECIAL INDUSTRIAL IMPROVEMENT'
            WHEN class = '589' THEN 'INDUSTRIAL CONDOMINIUM UNIT'
            WHEN class = '590' THEN 'COMMERCIAL MINOR IMPROVEMENT'
            WHEN class = '591' THEN 'COMMERCIAL BUILDING OVER THREE STORIES'
            WHEN class = '592' THEN 'TWO-OR-THREE-STORY BUILDING CONTAINING PART OR ALL RETAIL AND/OR COMMERCIAL SPACE'
            WHEN class = '593' THEN 'INDUSTRIAL BUILDING'
            WHEN class = '597' THEN 'SPECIAL COMMERCIAL STRUCTURE'
            WHEN class = '599' THEN 'COMMERCIAL CONDOMINIUM UNIT'
            WHEN class = '637' THEN 'INDUSTRIAL BROWNFIELD LAND'
            WHEN class = '638' THEN 'INDUSTRIAL BROWNFIELD'
            WHEN class = '650' THEN 'INDUSTRIAL LAND'
            WHEN class = '651' THEN 'INDUSTRIAL LAND'
            WHEN class = '654' THEN 'OTHER INDUSTRIAL BROWNFIELD MINOR IMPROVEMENTS'
            WHEN class = '655' THEN 'GARAGE USED IN CONJUNCTION WITH INDUSTRIAL BROWNFIELD INCENTIVE IMPROVEMENT'
            WHEN class = '663' THEN 'INDUSTRIAL BUILDING'
            WHEN class = '666' THEN 'INDUSTRIAL BROWNFIELD QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '668' THEN 'SPECIAL INDUSTRIAL BROWNFIELD IMPROVEMENT'
            WHEN class = '669' THEN 'INDUSTRIAL BROWNFIELD CONDOMINIUM UNIT'
            WHEN class = '670' THEN 'INDUSTRIAL MINOR IMPROVEMENT'
            WHEN class = '671' THEN 'GARAGE USED IN CONJUNCTION WITH INDUSTRIAL INCENTIVE IMPROVEMENT'
            WHEN class = '673' THEN 'INDUSTRIAL QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '677' THEN 'SPECIAL INDUSTRIAL IMPROVEMENT'
            WHEN class = '679' THEN 'INDUSTRIAL CONDOMINIUM UNIT'
            WHEN class = '680' THEN 'INDUSTRIAL MINOR IMPROVEMENT'
            WHEN class = '681' THEN 'GARAGE USED IN CONJUNCTION WITH INDUSTRIAL INCENTIVE IMPROVEMENT'
            WHEN class = '683' THEN 'INDUSTRIAL QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '687' THEN 'SPECIAL INDUSTRIAL IMPROVEMENT'
            WHEN class = '689' THEN 'INDUSTRIAL CONDOMINIUM UNIT'
            WHEN class = '693' THEN 'INDUSTRIAL BUILDING'
            WHEN class = '700' THEN 'COMMERCIAL INCENTIVE LAND'
            WHEN class = '701' THEN 'GARAGE USED IN CONJUNCTION WITH COMMERCIAL INCENTIVE IMPROVEMENT'
            WHEN class = '716' THEN 'NON-FIREPROOF HOTEL OR ROOMING HOUSE (APARTMENT HOTEL)'
            WHEN class = '717' THEN 'ONE-STORY COMMERCIAL USE BUILDING'
            WHEN class = '722' THEN 'GARAGE, SERVICE STATION'
            WHEN class = '723' THEN 'GASOLINE STATION, WITH /WITHOUT BAYS, STORE'
            WHEN class = '726' THEN 'COMMERCIAL GREENHOUSE'
            WHEN class = '727' THEN 'THEATRE'
            WHEN class = '728' THEN 'BANK BUILDING'
            WHEN class = '729' THEN 'MOTEL'
            WHEN class = '730' THEN 'SUPERMARKET'
            WHEN class = '731' THEN 'SHOPPING CENTER'
            WHEN class = '732' THEN 'BOWLING ALLEY'
            WHEN class = '733' THEN 'QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '735' THEN 'GOLF COURSE LAND'
            WHEN class = '742' THEN 'COMMERCIAL INCENTIVE LAND'
            WHEN class = '743' THEN 'GARAGE USED IN CONJUNCTION WITH COMMERCIAL INCENTIVE IMPROVEMENT'
            WHEN class = '745' THEN 'GOLF COURSE LAND'
            WHEN class = '746' THEN 'NON-FIREPROOF HOTEL OR ROOMING HOUSE (APARTMENT HOTEL)'
            WHEN class = '747' THEN 'ONE-STORY COMMERCIAL BUILDING'
            WHEN class = '748' THEN 'MOTEL'
            WHEN class = '752' THEN 'GARAGE, SERVICE STATION'
            WHEN class = '753' THEN 'GASOLINE STATION, WITH/WITHOUT BAYS, STORE'
            WHEN class = '756' THEN 'COMMERCIAL GREENHOUSE'
            WHEN class = '757' THEN 'THEATRE'
            WHEN class = '758' THEN 'BANK BUILDING'
            WHEN class = '760' THEN 'SUPERMARKET'
            WHEN class = '761' THEN 'SHOPPING CENTER (REGIONAL, COMMUNITY, NEIGHBORHOOD, PROMOTIONAL, SPECIALTY)'
            WHEN class = '762' THEN 'BOWLING ALLEY'
            WHEN class = '764' THEN 'QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '765' THEN 'OTHER MINOR COMMERCIAL IMPROVEMENTS'
            WHEN class = '767' THEN 'SPECIAL COMMERCIAL STRUCTURE'
            WHEN class = '772' THEN 'TWO-OR-THREE-STORY BUILDING, CONTAINING PART OR ALL RETAIL AND/OR COMMERCIAL SPACE'
            WHEN class = '774' THEN 'OFFICE BUILDING'
            WHEN class = '790' THEN 'OTHER MINOR COMMERCIAL IMPROVEMENT'
            WHEN class = '791' THEN 'OFFICE BUILDING (ONE STORY, LOW, RISE, MID RISE, HIGH RISE)'
            WHEN class = '792' THEN 'TWO-OR-THREE-STORY BUILDING CONTAINING PART OR ALL RETAIL AND/OR COMMERCIAL SPACE'
            WHEN class = '797' THEN 'SPECIAL COMMERCIAL STRUCTURE'
            WHEN class = '798' THEN 'COMMERCIAL/INDUSTRIAL-CONDOMINIUM UNITS/GARAGE'
            WHEN class = '799' THEN 'COMMERCIAL/INDUSTRIAL-CONDOMINIUM UNIT/GARAGE'
            WHEN class = '800' THEN 'COMMERCIAL INCENTIVE LAND'
            WHEN class = '801' THEN 'GARAGE USED IN CONJUNCTION WITH COMMERCIAL INCENTIVE IMPROVEMENT'
            WHEN class = '816' THEN 'NON-FIREPROOF HOTEL OR ROOMING HOUSE (APARTMENT HOTEL)'
            WHEN class = '817' THEN 'ONE-STORY COMMERCIAL BUILDING'
            WHEN class = '822' THEN 'GARAGE, SERVICE STATION'
            WHEN class = '823' THEN 'GASOLINE STATION WITH/WITHOUT BAY, STORE'
            WHEN class = '826' THEN 'COMMERCIAL GREENHOUSE'
            WHEN class = '827' THEN 'THEATRE'
            WHEN class = '828' THEN 'BANK BUILDING'
            WHEN class = '829' THEN 'MOTEL'
            WHEN class = '830' THEN 'SUPERMARKET'
            WHEN class = '831' THEN 'SHOPPING CENTER (REGIONAL, COMMUNITY, NEIGHBORHOOD, PROMOTIONAL, SPECIALTY)'
            WHEN class = '832' THEN 'BOWLING ALLEY'
            WHEN class = '833' THEN 'QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '835' THEN 'GOLF COURSE LAND'
            WHEN class = '850' THEN 'INDUSTRIAL INCENTIVE LAND'
            WHEN class = '880' THEN 'INDUSTRIAL MINOR IMPROVEMENT'
            WHEN class = '881' THEN 'GARAGE USED IN CONJUNCTION WITH INDUSTRIAL INCENTIVE IMPROVEMENT'
            WHEN class = '883' THEN 'QUONSET HUT OR BUTLER TYPE BUILDING'
            WHEN class = '887' THEN 'SPECIAL INDUSTRIAL IMPROVEMENT'
            WHEN class = '889' THEN 'INDUSTRIAL CONDOMINIUM UNIT'
            WHEN class = '890' THEN 'MINOR INDUSTRIAL IMPROVEMENT'
            WHEN class = '891' THEN 'OFFICE BUILDING'
            WHEN class = '892' THEN 'TWO-OR-THREE-STORY BUILDING CONTAINING PART OR ALL RETAIL AND/OR COMMERCIAL SPACE'
            WHEN class = '893' THEN 'INDUSTRIAL BUILDING'
            WHEN class = '897' THEN 'SPECIAL COMMERCIAL STRUCTURE'
            WHEN class = '899' THEN 'COMMERCIAL/INDUSTRIAL CONDOMINIUM UNIT/GARAGE'
            WHEN class = '900' THEN 'LAND USED IN CONJUNCTION WITH INCENTIVE RENTAL APARTMENTS'
            WHEN class = '901' THEN 'GARAGE USED IN CONJUNCTION WITH INCENTIVE RENTAL APARTMENT'
            WHEN class = '913' THEN 'TWO-OR-THREE-STORY APARTMENT BUILDING, SEVEN OR MORE UNITS'
            WHEN class = '914' THEN 'TWO-OR-THREE-STORY, NON-FIREPROOF COURT AND CORRIDOR APARTMENTS OR CALIFORNIA TYPE APARTMENTS, NO CORRIDORS, EXTERIOR ENTRANCE'
            WHEN class = '915' THEN 'TWO-OR-THREE-STORY NON-FIREPROOF CORRIDOR APARTMENTS, OR CALIFORNIA TYPE APARTMENTS, INTERIOR ENTRANCE'
            WHEN class = '918' THEN 'MIXED USE COMMERCIAL/RESIDENTIAL BUILDING WITH APARTMENTS AND COMMERCIAL AREA WHERE THE COMMERCIAL AREA IS GRANTED AN INCENTIVE USE'
            WHEN class = '959' THEN 'RENTAL CONDOMINIUM UNIT'
            WHEN class = '990' THEN 'OTHER MINOR IMPROVEMENTS'
            WHEN class = '991' THEN 'APARTMENT BUILDINGS OVER THREE STORIES'
            WHEN class = '996' THEN 'RENTED MODERN ROW HOUSES, SEVEN OR MORE UNITS IN A SINGLE DEVELOPMENT OR ONE OR MORE CONTIGUOUS PARCELS IN COMMON OWNERSHIP'
            WHEN class = '997' THEN 'SPECIAL RENTAL STRUCTURE'
        END AS class_descr
    FROM {{ ref('cook_county_parcel_sales_clean') }}
),
price_change_since_last_sale AS (
    SELECT
        parcel_sale_id,
        pin,
        class,
        class_descr,
        is_multisale,
        num_parcels_sale,
        sale_price,
        sale_date,
        last_sale_price,
        last_sale_date,
        (sale_price::real - last_sale_price::real)    AS price_change_since_last_sale,
        (sale_date - last_sale_date)::real / 365.2422 AS years_since_last_sale,
        last_sale_was_multisale,
        num_parcels_last_sale
    FROM last_parcel_sale
)

SELECT *
FROM price_change_since_last_sale
ORDER BY pin, sale_date
