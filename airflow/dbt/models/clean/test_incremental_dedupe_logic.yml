unit_tests:
  - name: chicago_towed_vehicles_clean_initial_full_refresh
    description: >
      Scenario: Clean-stage deduplication.
        Multiple distinct versions of records were ingested to data_raw and only the
        latest version of each record should be retained.
    model: chicago_towed_vehicles_clean
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('chicago_towed_vehicles_standardized')
        format: dict
        rows:
          - vehicle_tow_id: '1'
            inventory_number: '111111'
            tow_date: '2024-05-22'
            plate: '123456A'
            towed_to_address: '701 N. Sacramento'
            source_data_updated: '2024-12-01T11:01:39Z'
          - vehicle_tow_id: '1'
            inventory_number: '111111'
            tow_date: '2024-05-22'
            plate: '123456A'
            towed_to_address: '10300 S. Doty'
            source_data_updated: '2024-12-01T22:46:51Z'
    expect:
      rows:
        - vehicle_tow_id: '1'
          inventory_number: '111111'
          tow_date: '2024-05-22'
          plate: '123456A'
          towed_to_address: '10300 S. Doty'
          source_data_updated: '2024-12-01T22:46:51Z'

  - name: chicago_towed_vehicles_clean_incremental_mode_basic_case
    description: >
      Scenario: a new record is added along with an existing record
        that hasn't changed.
    model: chicago_towed_vehicles_clean
    overrides:
      macros:
        is_incremental: true
    given:
      - input: ref('chicago_towed_vehicles_standardized')
        format: dict
        rows:
          - vehicle_tow_id: '1'
            inventory_number: '111111'
            tow_date: '2024-05-22'
            plate: '123456A'
            towed_to_address: '701 N. Sacramento'
            source_data_updated: '2024-12-01T11:01:39Z'
          - vehicle_tow_id: '2'
            inventory_number: '111112'
            tow_date: '2024-05-24'
            plate: 'B123321'
            towed_to_address: '10300 S. Doty'
            source_data_updated: '2024-12-04T08:13:25Z'
      - input: this
        rows:
          - vehicle_tow_id: '1'
            inventory_number: '111111'
            tow_date: '2024-05-22'
            plate: '123456A'
            towed_to_address: '701 N. Sacramento'
            source_data_updated: '2024-12-01T11:01:39Z'
    expect:
      rows:
        - vehicle_tow_id: '2'
          inventory_number: '111112'
          tow_date: '2024-05-24'
          plate: 'B123321'
          towed_to_address: '10300 S. Doty'
          source_data_updated: '2024-12-04T08:13:25Z'

